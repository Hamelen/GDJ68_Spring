<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.iu.main.board.qna.QnaDAO">
	<sql id="searchSql">
		WHERE BOARDNUM>0
		AND
		<choose>
			<when test="kind=='name'">
				BOARDNAME LIKE '%' || #{search} || '%'
			</when>
			<when test="kind=='writer'">
				WRITER LIKE '%' || #{search} || '%'
			</when>
			<otherwise>
				BOARDCONTENTS LIKE '%' || #{search} || '%'
			</otherwise>
		</choose>
	</sql>


	<select id="getList" resultType="QnaDTO" parameterType="Pager">
		SELECT *
		FROM (SELECT ROWNUM R, Q.*
		FROM(SELECT * FROM QNABOARD

		<include refid="searchSql"></include>

		ORDER BY REF DESC, STEP ASC) Q)
		WHERE R BETWEEN #{startRow} AND #{lastRow}
	</select>

	<select id="getTotal" resultType="Long" parameterType="Pager">
		SELECT COUNT(BOARDNUM) FROM QNABOARD

		<include refid="searchSql"></include>

	</select>

	<select id="getDetail" resultType="QnaDTO"
		parameterType="QnaDTO">
		SELECT *
		FROM QNABOARD
		WHERE BOARDNUM = #{boardNum}
	</select>

	<insert id="setAdd" parameterType="QnaDTO">
		<selectKey resultType="Long" keyProperty="boardNum"
			order="BEFORE">
			SELECT QNA_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO QNABOARD
		(BOARDNUM, WRITER, BOARDNAME, BOARDCONTENTS,
		BOARDDATE, BOARDHIT, REF, STEP,
		DEPTH) VALUES
		(#{boardNum},
		#{writer}, #{boardName}, #{boardContents}, 
		SYSDATE, 0, #{boardNum}, 0, 0)
	</insert>
	

    <!-- 답글 추가 -->
	<insert id="setReplyAdd" parameterType="QnaDTO">
	<selectKey resultType="Long" keyProperty="boardNum"
			order="BEFORE">
			SELECT QNA_SEQ.NEXTVAL FROM DUAL
		</selectKey>
	    INSERT INTO QNABOARD (BOARDNUM, WRITER, BOARDNAME, 
	    BOARDCONTENTS, BOARDDATE, BOARDHIT, REF, STEP, DEPTH)
	    VALUES (#{boardNum}, #{writer}, #{boardName}, 
	    #{boardContents},SYSDATE, 0, #{ref}, #{step}, #{depth})
	</insert>
	
	<!-- 답글이 추가되기 전 -->
	<update id="setStepUpdate" parameterType="QnaDTO">
	    UPDATE QNABOARD 
	    SET STEP=STEP+1
	    WHERE REF=#{ref} AND STEP>#{step}
	</update>
	
	<update id="setUpdate" parameterType="QnaDTO">
	    UPDATE QNABOARD
	    SET WRITER=#{writer}, BOARDHIT=#{boardHit}, BOARDNAME=#{boardName}, BOARDCONTENTS=#{boardContents}
	    WHERE BOARDNUM=#{boardNum}
	</update>
	
	<delete id="setDelete" parameterType="QnaDTO">
	    DELETE QNABOARD
	    WHERE BOARDNUM=#{boardNum}
	</delete>

</mapper>